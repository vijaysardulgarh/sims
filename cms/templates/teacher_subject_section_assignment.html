{% load static %}
{% load custom_tags %}

<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Assign Sections & Subjects to Teachers</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
</head>

<body class="bg-light">

    <div class="container mt-5">
        <div class="card shadow rounded-3">
            <div class="card-header bg-primary text-white">
                <h4>Assign Sections & Subjects to Teachers</h4>
            </div>
            <div class="card-body">

                <div class="accordion" id="teacherAccordion">
                    {% for teacher in teachers %}
                        <div class="accordion-item">
                            <h2 class="accordion-header" id="heading{{ teacher.id }}">
                                <button class="accordion-button collapsed" type="button"
                                    data-bs-toggle="collapse"
                                    data-bs-target="#collapse{{ teacher.id }}"
                                    aria-expanded="false">
                                    {{ teacher.post_type.name|default:"No Post Type" }} - {{ teacher.name }} ({{ teacher.employee_id }})
                                </button>
                            </h2>
                            <div id="collapse{{ teacher.id }}" class="accordion-collapse collapse"
                                aria-labelledby="heading{{ teacher.id }}" data-bs-parent="#teacherAccordion">
                                <div class="accordion-body">

                                    <form method="POST">
                                        {% csrf_token %}
                                        <table class="table table-bordered">
                                            <thead>
                                                <tr>
                                                    <th>Section</th>
                                                    <th>Subjects</th>
                                                </tr>
                                            </thead>
                                            <tbody id="section-table-{{ teacher.id }}">
                                                {% if teacher_assignments|get_item:teacher.id %}
                                                    {% for section_id, subject_ids in teacher_assignments|get_item:teacher.id|dict_items %}
                                                        {% with section=sections|get_item:section_id %}
                                                            <tr>
                                                                <td>
                                                                    <select name="teacher_{{ teacher.id }}_section_{{ forloop.counter0 }}"
                                                                        class="form-select section-select"
                                                                        onchange="loadSubjects(this, {{ teacher.id }}, {{ forloop.counter0 }})">
                                                                        <option value="">Select Section</option>
                                                                        {% for sec_id, sec in sections.items %}
                                                                            <option value="{{ sec_id }}"
                                                                                {% if sec_id == section_id %}selected{% endif %}>
                                                                                {{ sec.full_display }}
                                                                            </option>
                                                                        {% endfor %}
                                                                    </select>
                                                                </td>
                                                                <td>
                                                                    <select name="teacher_{{ teacher.id }}_section_{{ forloop.counter0 }}_subjects"
                                                                        class="form-select subject-select" multiple data-placeholder="Select Subjects">
                                                                        {% for sub_id in subject_ids %}
                                                                            {% with class_sub=class_subjects|get_item:sub_id %}
                                                                                <option value="{{ sub_id }}" selected>
                                                                                    {{ class_sub.subject.name }}
                                                                                </option>
                                                                            {% endwith %}
                                                                        {% endfor %}
                                                                    </select>
                                                                </td>
                                                            </tr>
                                                        {% endwith %}
                                                    {% endfor %}
                                                {% else %}
                                                    <tr>
                                                        <td>
                                                            <select name="teacher_{{ teacher.id }}_section_0"
                                                                class="form-select section-select"
                                                                onchange="loadSubjects(this, {{ teacher.id }}, 0)">
                                                                <option value="">Select Section</option>
                                                                {% for sec_id, sec in sections.items %}
                                                                    <option value="{{ sec_id }}">{{ sec.school_class.name }} {{ sec.name }} {% if sec.school_class.medium %} ({{ sec.school_class.medium }}){% endif %}{% if sec.school_class.stream %} ({{ sec.school_class.stream }}){% endif %}</option>
                                                                {% endfor %}
                                                            </select>
                                                        </td>
                                                        <td>
                                                            <select name="teacher_{{ teacher.id }}_section_0_subjects"
                                                                class="form-select subject-select" multiple data-placeholder="Select Subjects">
                                                            </select>
                                                        </td>
                                                    </tr>
                                                {% endif %}
                                            </tbody>
                                        </table>

                                        <button type="button" class="btn btn-secondary btn-sm mb-2"
                                            onclick="addRow({{ teacher.id }})">Add Section</button>

                                        <div class="text-end">
                                            <button type="submit" class="btn btn-success">Save Assignments</button>
                                        </div>
                                    </form>

                                </div>
                            </div>
                        </div>
                    {% endfor %}
                </div>

            </div>
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

    <script>
        $(document).ready(function () {
            $('.subject-select').select2({ placeholder: 'Select Subjects', allowClear: true, width: '100%' });
            $('.section-select').select2({ placeholder: 'Select Section', allowClear: true, width: '100%' });
        });

        let indices = {};
        {% for teacher in teachers %}
            indices[{{ teacher.id }}] = {% if teacher_assignments|get_item:teacher.id %}{{ teacher_assignments|get_item:teacher.id|length }}{% else %}1{% endif %};
        {% endfor %}

        function loadSubjects(sectionSelect, teacherId, rowIndex) {
            const sectionId = sectionSelect.value;
            const subjectSelect = sectionSelect.closest('tr').querySelector('.subject-select');
            $(subjectSelect).empty().trigger('change');

            if (!sectionId) return;

            $.ajax({
                url: "{% url 'get_subjects_for_section' %}",
                data: { section_id: sectionId },
                dataType: "json",
                success: function (data) {
                    data.subjects.forEach(sub => {
                        const newOption = new Option(sub.name, sub.id, false, false);
                        $(subjectSelect).append(newOption);
                    });
                    $(subjectSelect).trigger('change');
                }
            });
        }

        function addRow(teacherId) {
            let tbody = document.getElementById('section-table-' + teacherId);
            let index = indices[teacherId];

            let sectionOptions = `
                {% for sec_id, sec in sections.items %}
                    <option value="{{ sec_id }}">{{ sec.full_display }}</option>
                {% endfor %}
            `;

            let newRow = document.createElement('tr');
            newRow.innerHTML = `
                <td>
                    <select name="teacher_${teacherId}_section_${index}" class="form-select section-select" onchange="loadSubjects(this, ${teacherId}, ${index})">
                        <option value="">Select Section</option>
                        ${sectionOptions}
                    </select>
                </td>
                <td>
                    <select name="teacher_${teacherId}_section_${index}_subjects" class="form-select subject-select" multiple data-placeholder="Select Subjects">
                    </select>
                </td>
            `;

            tbody.appendChild(newRow);

            $(newRow).find('.subject-select').select2({ placeholder: 'Select Subjects', allowClear: true, width: '100%' });
            $(newRow).find('.section-select').select2({ placeholder: 'Select Section', allowClear: true, width: '100%' });

            indices[teacherId]++;
        }
    </script>

</body>
</html>
