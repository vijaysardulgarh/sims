{% extends 'base.html' %}
{% load static %}
{% block title %}Dashboard{% endblock %}

{% block content %}
<div class="container my-4 position-relative">

    <!-- Login Button to trigger modal -->
    <div class="text-end mb-3">
        {% if not user.is_authenticated %}
        <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#loginModal">
            <i class="bi bi-box-arrow-in-right"></i> Login
        </button>
        {% else %}
        <span class="badge bg-success">Logged in as {{ user.username }}</span>
        {% endif %}
    </div>

    <!-- Login Modal -->
    <div class="modal fade" id="loginModal" tabindex="-1" aria-labelledby="loginModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content shadow-sm">
                <div class="modal-header bg-dark text-white">
                    <h5 class="modal-title" id="loginModalLabel"><i class="bi bi-box-arrow-in-right"></i> Login</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form method="post" action="{% url 'login' %}">
                        {% csrf_token %}
                        <div class="mb-3">
                            <label for="username" class="form-label">Username</label>
                            <input type="text" id="username" name="username" class="form-control" required>
                        </div>
                        <div class="mb-3">
                            <label for="password" class="form-label">Password</label>
                            <input type="password" id="password" name="password" class="form-control" required>
                        </div>
                        <button type="submit" class="btn btn-primary w-100"><i class="bi bi-box-arrow-in-right"></i> Login</button>
                    </form>
                    <div class="mt-2 text-center">
                        <a href="#" class="small text-decoration-none">Forgot Password?</a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Banner Carousel with captions -->
    <div id="schoolBannerCarousel" class="carousel slide mb-4 shadow-sm rounded" data-bs-ride="carousel">
        <div class="carousel-inner">
            <div class="carousel-item active">
                <img src="{% static 'banner/banner1.jpg' %}" class="d-block w-100 rounded" alt="School Banner 1">
                <div class="carousel-caption d-none d-md-block bg-dark bg-opacity-50 rounded p-2">
                    <h5>
                        Welcome to 
                        {% if selected_school %}
                            {{ selected_school.name }}
                        {% else %}
                            Our School
                        {% endif %}
                    </h5>
                    <p>Excellence in Education & Co-Curricular Activities</p>
                </div>
            </div>
            <div class="carousel-item">
                <img src="{% static 'banner/banner2.jpg' %}" class="d-block w-100 rounded" alt="School Banner 2">
            </div>
            <div class="carousel-item">
                <img src="{% static 'banner/banner1.jpg' %}" class="d-block w-100 rounded" alt="School Banner 3">
            </div>
        </div>
        <button class="carousel-control-prev" type="button" data-bs-target="#schoolBannerCarousel" data-bs-slide="prev">
            <span class="carousel-control-prev-icon" aria-hidden="true"></span>
        </button>
        <button class="carousel-control-next" type="button" data-bs-target="#schoolBannerCarousel" data-bs-slide="next">
            <span class="carousel-control-next-icon" aria-hidden="true"></span>
        </button>
    </div>

    <!-- Quick School Selection -->
    <div class="card mb-4 shadow-sm border-0">
        <div class="card-header bg-primary text-white">
            <h5 class="mb-0"><i class="bi bi-building"></i> Select School</h5>
        </div>
        <div class="card-body">
            <form method="post">
                {% csrf_token %}
                <div class="row align-items-center">
                    <div class="col-md-6">
                        <select name="school" class="form-select" required>
                            <option value="">-- Choose a School --</option>
                            {% for school in schools %}
                            <option value="{{ school.id }}" {% if selected_school and school.id == selected_school.id %}selected{% endif %}>
                                {{ school.name }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-2">
                        <button type="submit" class="btn btn-light"><i class="bi bi-check-circle"></i> Select</button>
                    </div>
                    {% if selected_school %}
                    <div class="col-md-4 text-end">
                        <span class="badge bg-success">Current School: {{ selected_school.name }}</span>
                    </div>
                    {% endif %}
                </div>
            </form>
        </div>
    </div>

    <!-- Sanctioned Posts with Animated Counters -->
    <div class="row mb-4">
        {% for group_name, group_data in staff_stats.items %}
        <div class="col-md-6">
            <div class="card shadow-sm mb-4 border-0 hover-shadow">
                <div class="card-header bg-warning text-dark">
                    <h5 class="mb-0"><i class="bi bi-people"></i> Sanctioned Posts 
                        {% if group_name == '6th_to_8th' %}(6th to 8th){% else %}(9th to 12th){% endif %}
                    </h5>
                </div>
                <div class="table-responsive">
                    <table class="table table-bordered table-hover mb-0 align-middle text-center">
                        <thead class="table-light">
                            <tr>
                                <th>Designation</th>
                                <th>Sanctioned</th>
                                <th>Working Regular</th>
                                <th>Vacant After Regular</th>
                                <th>Guest</th>
                                <th>HKRNL</th>
                                <th>Net Vacancy</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for row in group_data %}
                            <tr>
                                <td>{{ row.designation }}</td>
                                <td><span class="counter" data-count="{{ row.sanctioned }}">0</span></td>
                                <td><span class="counter" data-count="{{ row.working_regular }}">0</span></td>
                                <td><span class="counter" data-count="{{ row.vacant_after_regular }}">0</span></td>
                                <td><span class="counter" data-count="{{ row.working_guest }}">0</span></td>
                                <td><span class="counter" data-count="{{ row.working_hkrnl }}">0</span></td>
                                <td class="{% if row.net_vacancy > 0 %}text-danger fw-bold{% endif %}">{{ row.net_vacancy }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>

    <!-- Tabbed News Section -->
    <div class="card shadow-sm mb-4 border-0 hover-shadow">
        <div class="card-header bg-success text-white">
            <h5 class="mb-0"><i class="bi bi-newspaper"></i> News & Updates</h5>
        </div>
        <div class="card-body">
            <ul class="nav nav-tabs mb-3" id="newsTab" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="latest-tab" data-bs-toggle="tab" data-bs-target="#latest" type="button">Latest News</button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="academic-tab" data-bs-toggle="tab" data-bs-target="#academic" type="button">Academic News</button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="events-tab" data-bs-toggle="tab" data-bs-target="#events" type="button">Events</button>
                </li>
            </ul>
            <div class="tab-content" id="newsTabContent">
                <div class="tab-pane fade show active" id="latest">
                    {% if news_list %}
                    <ul class="list-group list-group-flush">
                        {% for news in news_list %}
                        <li class="list-group-item d-flex align-items-start">
                            {% if news.image %}
                                <img src="{{ news.image.url }}" alt="{{ news.title }}" class="img-thumbnail me-3" style="width:60px; height:60px; object-fit:cover;">
                            {% endif %}
                            <div>
                                <strong>{{ news.title }}</strong> <br>
                                <small class="text-muted">{{ news.date|date:"d M Y" }}</small>
                                <p class="mb-0">{{ news.content|truncatechars:120 }}</p>
                            </div>
                        </li>
                        {% endfor %}
                    </ul>
                    {% else %}
                    <div class="text-muted fst-italic">No news or announcements available.</div>
                    {% endif %}
                </div>
                <div class="tab-pane fade" id="academic">
                    {% if academic_news %}
                    <ul class="list-group list-group-flush">
                        {% for news in academic_news %}
                        <li class="list-group-item d-flex align-items-start">
                            {% if news.image %}
                                <img src="{{ news.image.url }}" alt="{{ news.title }}" class="img-thumbnail me-3" style="width:40px; height:40px; object-fit:cover;">
                            {% endif %}
                            <div>
                                <strong>{{ news.title }}</strong> <br>
                                <small class="text-muted">{{ news.date_published|date:"d M Y" }}</small>
                            </div>
                        </li>
                        {% endfor %}
                    </ul>
                    {% else %}
                    <div class="text-muted fst-italic">No academic news available.</div>
                    {% endif %}
                </div>
                <div class="tab-pane fade" id="events">
                    {% if event_news %}
                    <ul class="list-group list-group-flush">
                        {% for news in event_news %}
                        <li class="list-group-item d-flex align-items-start">
                            {% if news.image %}
                                <img src="{{ news.image.url }}" alt="{{ news.title }}" class="img-thumbnail me-3" style="width:40px; height:40px; object-fit:cover;">
                            {% endif %}
                            <div>
                                <strong>{{ news.title }}</strong> <br>
                                <small class="text-muted">{{ news.date_published|date:"d M Y" }}</small>
                            </div>
                        </li>
                        {% endfor %}
                    </ul>
                    {% else %}
                    <div class="text-muted fst-italic">No events available.</div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Quick Links Section -->
    <div class="card shadow-sm mb-4 border-0 hover-shadow">
        <div class="card-header bg-info text-white">
            <h5 class="mb-0"><i class="bi bi-link-45deg"></i> Quick Links</h5>
        </div>
        <div class="card-body">
            <div class="row g-3">
                <div class="col-md-3"><a href="#" class="btn btn-outline-primary w-100"><i class="bi bi-file-earmark-text"></i> Admissions</a></div>
                <div class="col-md-3"><a href="#" class="btn btn-outline-success w-100"><i class="bi bi-calendar"></i> Academic Calendar</a></div>
                <div class="col-md-3"><a href="#" class="btn btn-outline-warning w-100"><i class="bi bi-newspaper"></i> Notices</a></div>
                <div class="col-md-3"><a href="#" class="btn btn-outline-danger w-100"><i class="bi bi-people"></i> Staff Directory</a></div>
            </div>
        </div>
    </div>

</div>

<!-- Optional CSS for hover shadow and counters -->
<style>
    .hover-shadow:hover {
        box-shadow: 0 0.75rem 1.5rem rgba(0,0,0,0.25) !important;
        transition: 0.3s;
    }
    .counter {
        font-weight: 600;
        color: #0d6efd;
    }
</style>

<!-- JS for Animated Counters -->
<script>
    document.addEventListener("DOMContentLoaded", () => {
        const counters = document.querySelectorAll('.counter');
        counters.forEach(counter => {
            const updateCount = () => {
                const target = +counter.getAttribute('data-count');
                const count = +counter.innerText;
                const increment = Math.ceil(target / 100);
                if(count < target){
                    counter.innerText = count + increment;
                    setTimeout(updateCount, 20);
                } else {
                    counter.innerText = target;
                }
            };
            updateCount();
        });
    });
</script>

{% endblock %}
